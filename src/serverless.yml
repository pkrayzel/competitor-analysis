service: competitor-analysis

provider:
  name: aws
  runtime: python3.7
  memorySize: 512    # MB ram
  timeout: 180       # seconds

# https://medium.com/@glicht/serverless-framework-defining-per-function-iam-roles-c678fa09f46d
functions:
  category-spider:
    handler: category_spider.handler
#    events:
#      - schedule:
#          rate: rate(24 hours)
    timeout: 300
    iamRoleStatements:
    - Effect: "Allow"
      Action:
       - s3:PutObject
       - s3:Get*
       - s3:List*
      Resource: arn:aws:s3:::${self:custom.bucket_name}/*
    - Effect: Allow
      Action:
        - dynamodb:List*
        - dynamodb:Describe*
        - dynamodb:Get*
      Resource: arn:aws:dynamodb:*:*:table/competitor*
    environment:
      ENV: ${opt:stage, 'dev'}
      BUCKET_NAME: ${self:custom.bucket_name}

  s3-json-to-dynamodb:
    handler: s3_json_to_dynamodb.handler
    events:
      - s3:
          bucket: ${self:custom.bucket_name}
          event: s3:ObjectCreated:*
          rules:
            - suffix: .json
    iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:Get*
        - s3:List*
      Resource: arn:aws:s3:::${self:custom.bucket_name}/*
    - Effect: Allow
      Action:
        - dynamodb:BatchWriteItem
      Resource: arn:aws:dynamodb:*:*:table/competitor*
    environment:
      ENV: ${opt:stage, 'dev'}

  empty:
    handler: empty.handler
    events:
      - stream:
          type: dynamodb
          batchSize: 1
          arn:
            Fn::GetAtt:
              - CategoryOverallTable
              - StreamArn
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:*
        Resource: arn:aws:s3:::${self:custom.bucket_name}/*
      - Effect: Allow
        Action:
          - dynamodb:*
        Resource: arn:aws:dynamodb:*:*:table/competitor*
    environment:
      ENV: ${opt:stage, 'dev'}

  product-pages-spider:
    handler: product_pages_spider.handler
#    events:
#      - stream:
#          type: dynamodb
#          batchSize: 1
#          arn:
#            Fn::GetAtt:
#              - CategoryOverallTable
#              - StreamArn
    timeout: 900 # 15 minutes for scraping
    iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:*
      Resource: arn:aws:s3:::${self:custom.bucket_name}/*
    - Effect: Allow
      Action:
        - dynamodb:*
      Resource: arn:aws:dynamodb:*:*:table/competitor*
    environment:
      ENV: ${opt:stage, 'dev'}

custom:
  pythonRequirements:
    dockerizePip: true
    slim: true
  bucket_name: made-${opt:stage, 'dev'}-competitor-analysis

plugins:
  - serverless-python-requirements
  - serverless-iam-roles-per-function

resources:
  Resources:
    CategoryOverallTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: competitor_category_overall_info_${opt:stage, 'dev'}
        AttributeDefinitions:
          - AttributeName: country_competitor_category_page_number
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: country_competitor_category_page_number
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        StreamSpecification:
          StreamViewType: NEW_IMAGE
